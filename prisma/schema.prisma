generator client { provider = "prisma-client-js" }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Supplier {
  id             Int               @id @default(autoincrement())
  name           String            @unique
  vatNumber      String?
  contactName    String?
  phone          String?
  email          String?
  address        String?
  status         String            @default("active")
  createdAt      DateTime          @default(now())

  invoices       Invoice[]
  purchaseOrders PurchaseOrder[]
  payments       SupplierPayment[]  // دفعات على مستوى المورد
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  createdAt DateTime  @default(now())
  invoices  Invoice[]
}

model Invoice {
  id               Int        @id @default(autoincrement())
  supplierId       Int
  categoryId       Int?
  invoiceNumber    String
  description      String?
  notes            String?
  invoiceDate      DateTime
  amountBeforeTax  Decimal    @db.Decimal(12, 2)
  vatRate          Decimal    @db.Decimal(5, 4)
  taxAmount        Decimal    @db.Decimal(12, 2)
  totalAmount      Decimal    @db.Decimal(12, 2)
  createdAt        DateTime   @default(now())

  supplier   Supplier  @relation(fields: [supplierId], references: [id])
  category   Category? @relation(fields: [categoryId], references: [id])
  files      InvoiceFile[]
  poLinks    PoInvoice[]

  @@unique([supplierId, invoiceNumber])
}

model InvoiceFile {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  fileUrl     String
  fileName    String
  contentType String
  sizeBytes   Int
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

model SupplierPayment {
  id         Int      @id @default(autoincrement())
  supplierId Int
  amount     Decimal  @db.Decimal(12, 2)
  paidAt     DateTime
  note       String?
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id])
}

model PurchaseOrder {
  id          Int        @id @default(autoincrement())
  supplierId  Int
  poNumber    String     @unique
  description String?
  poDate      DateTime
  amount      Decimal    @db.Decimal(12, 2)
  fileUrl     String?
  createdAt   DateTime   @default(now())

  supplier    Supplier   @relation(fields: [supplierId], references: [id])
  invoices    PoInvoice[]
}

model PoInvoice {
  id        Int      @id @default(autoincrement())
  poId      Int
  invoiceId Int

  po      PurchaseOrder @relation(fields: [poId], references: [id])
  invoice Invoice       @relation(fields: [invoiceId], references: [id])

  @@unique([poId, invoiceId])
}
